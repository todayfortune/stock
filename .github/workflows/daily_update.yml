name: ìœ¼ì™• ë ˆì´ë” ìë™ ë¶„ì„

on:
  schedule:
    - cron: '10 0 * * 1-5'  # 09:10
    - cron: '0 1 * * 1-5'   # 10:00
    - cron: '0 3 * * 1-5'   # 12:00
    - cron: '30 6 * * 1-5'  # 15:30
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v3

    # ğŸ‘‡ [ì¤‘ìš”] 3.9 -> 3.11ë¡œ ì—…ê·¸ë ˆì´ë“œ (ì´ê²Œ í•µì‹¬!)
    - name: íŒŒì´ì¬ ì„¤ì • (3.11 ë²„ì „)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      run: |
        pip install pandas numpy finance-datareader yfinance telethon

    - name: ìœ¼ì™• ë ˆì´ë” ê°€ë™ (ì£¼ì‹ ë°ì´í„°)
      run: |
        python scripts/fetch_krx.py

        # ğŸ‘‡ [ì—¬ê¸° ì¶”ê°€] ì›”ê°€ ì „ëµ ì—”ì§„ ê°€ë™
    - name: ì›”ê°€ ì „ëµ ë°±í…ŒìŠ¤íŒ…
      run: |
        python scripts/fetch_wallstreet.py
        # [2] SDI ì „ëµ ê°€ë™ (NEW)
    - name: SDI ì „ëµ ë°±í…ŒìŠ¤íŒ…
      run: |
        python scripts/fetch_sdi.py
        
        # ê¸°ì¡´ SDI ì‹¤í–‰ ì•„ë˜ì— ì¶”ê°€
    - name: í€€íŠ¸ ë¶„ì„ (PBR-ROE)
      run: |
        python scripts/fetch_quant.py

    - name: í…”ë ˆê·¸ë¨ ë‰´ìŠ¤ ìˆ˜ì§‘
      env:
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
      run: |
        python scripts/fetch_telegram.py

    - name: ê²°ê³¼ ì €ì¥ (Commit & Push)
      run: |
        git config --global user.name "Ki-hyun Bot"
        git config --global user.email "bot@todayfortune.com"
        git add data/
        git commit -m "ğŸ“ˆ ìœ¼ì™• ë ˆì´ë” ì—…ë°ì´íŠ¸ (Python 3.11 Fix)" || echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
        git push
